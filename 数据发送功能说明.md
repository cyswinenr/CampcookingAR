# 数据发送功能说明

## 📋 功能概述

实现了学生端数据自动发送到教师端服务器的功能。当用户在团队信息页面或团队分工页面进行保存或开始操作时，数据会自动发送到服务器。

## 🎯 实现位置

### 1. 团队信息页面（MainActivity）

**触发时机：**
- 点击"保存"按钮 → 自动发送团队信息
- 点击"开始野炊"按钮 → 自动发送团队信息

**发送内容：**
- 团队基本信息（学校、年级、班级、炉号、成员等）

### 2. 团队分工页面（TeamDivisionActivity）

**触发时机：**
- 点击"保存"按钮 → 自动发送完整数据
- 点击"开始野炊"按钮 → 自动发送完整数据

**发送内容：**
- 团队信息
- 过程记录（如果有）
- 课后总结（如果有）

## 🔧 技术实现

### 1. 核心类

#### DataSubmitManager.kt
数据提交管理器，负责：
- 打包数据为JSON格式
- 发送HTTP POST请求到服务器
- 处理成功/失败回调
- 错误处理和日志记录

**主要方法：**
- `submitTeamInfo()` - 提交团队信息
- `submitAllData()` - 提交完整数据
- `testConnection()` - 测试服务器连接

#### ServerConfigManager.kt
服务器配置管理器，负责：
- 保存和读取服务器IP地址
- 验证IP地址格式
- 生成服务器URL

**默认配置：**
- 服务器IP：192.168.1.100（可在代码中修改）
- 服务器端口：5000

### 2. 数据格式

发送的数据格式与服务器端完全兼容：

```json
{
  "teamInfo": {
    "school": "学校名称",
    "grade": "年级",
    "className": "班级",
    "stoveNumber": "炉号",
    "memberCount": 4,
    "memberNames": "成员姓名"
  },
  "processRecord": { ... },
  "summaryData": { ... },
  "exportTime": 1705296000000
}
```

### 3. 网络配置

**权限（AndroidManifest.xml）：**
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

**依赖（build.gradle）：**
```gradle
implementation 'com.squareup.okhttp3:okhttp:4.12.0'
```

## 📱 用户体验

### 发送提示

- **成功：** 显示 "✅ 团队信息已发送到服务器" 或 "✅ 数据已发送到服务器"
- **失败：** 显示 "⚠️ 发送失败: [错误信息]"

### 发送行为

- **后台发送：** 数据发送在后台线程执行，不阻塞UI
- **静默发送：** 发送失败不会中断用户操作流程
- **自动重试：** 用户再次保存时会自动重试发送

## 🔍 使用流程

### 场景1：团队信息页面

1. 用户填写团队信息
2. 点击"保存"按钮
   - ✅ 数据保存到本地
   - ✅ 自动发送到服务器
   - ✅ 显示发送结果提示
3. 点击"开始野炊"按钮
   - ✅ 验证信息完整性
   - ✅ 数据保存到本地
   - ✅ 自动发送到服务器
   - ✅ 跳转到团队分工页面

### 场景2：团队分工页面

1. 用户完成团队分工
2. 点击"保存"按钮
   - ✅ 分工信息保存到本地
   - ✅ 自动发送完整数据到服务器
   - ✅ 显示发送结果提示
3. 点击"开始野炊"按钮
   - ✅ 验证分工完整性
   - ✅ 分工信息保存到本地
   - ✅ 自动发送完整数据到服务器
   - ✅ 跳转到导航页面

## ⚙️ 配置说明

### 修改服务器IP地址

编辑 `ServerConfigManager.kt`：

```kotlin
private const val DEFAULT_SERVER_IP = "192.168.1.100"  // 修改为实际服务器IP
```

### 修改服务器端口

编辑 `ServerConfigManager.kt`：

```kotlin
private const val DEFAULT_PORT = 5000  // 修改为实际端口
```

## 🐛 故障排查

### 问题1：发送失败，提示"网络连接失败"

**可能原因：**
- 设备未连接到WiFi网络
- 服务器未启动
- IP地址配置错误

**解决方法：**
1. 检查设备WiFi连接
2. 确认服务器已启动
3. 检查服务器IP地址是否正确

### 问题2：发送失败，提示"服务器错误: 400"

**可能原因：**
- 数据格式错误
- 服务器端解析失败

**解决方法：**
1. 查看服务器日志
2. 检查数据格式是否正确

### 问题3：发送失败，提示"服务器错误: 500"

**可能原因：**
- 服务器内部错误
- 服务器存储空间不足

**解决方法：**
1. 查看服务器日志
2. 检查服务器存储空间
3. 重启服务器

## 📊 数据流向

```
学生端APP
    ↓
[保存/开始按钮]
    ↓
DataSubmitManager
    ↓
打包数据为JSON
    ↓
HTTP POST请求
    ↓
教师端服务器 (http://IP:5000/api/submit)
    ↓
服务器保存数据
    ↓
返回成功/失败响应
```

## 🔐 注意事项

1. **网络要求：** 确保学生端和服务器在同一局域网
2. **服务器状态：** 发送前确保服务器已启动
3. **数据完整性：** 发送失败不影响本地数据保存
4. **错误处理：** 发送失败会显示错误提示，但不会中断用户操作

## 🚀 后续优化建议

1. **IP地址配置界面：** 添加设置页面，允许用户输入服务器IP
2. **发送历史：** 记录发送历史，显示发送状态
3. **自动重试：** 发送失败后自动重试机制
4. **离线队列：** 网络断开时保存到队列，网络恢复后自动发送

## 📝 更新日志

- 2024-01-15: 初始版本
  - 实现团队信息自动发送
  - 实现完整数据自动发送
  - 添加错误处理和用户提示

