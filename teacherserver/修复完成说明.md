# 媒体文件数据修复完成说明

## ✅ 已完成的修复

### 1. 修改 `app.py` - 立即保存原始 JSON 数据

**位置**：`teacherserver/app.py` 的 `submit_student_data()` 方法

**修改内容**：
- ✅ 在接收数据后立即检查是否包含 `stages` 字段
- ✅ 立即保存原始 JSON 数据到文件系统（带时间戳和 latest.json）
- ✅ 添加详细的调试日志，记录接收到的数据内容
- ✅ 统计每个阶段的媒体文件数量

**关键功能**：
```python
# 1. 立即检查数据
- 检查 processRecord 是否存在
- 检查是否包含 stages 字段
- 统计媒体文件数量

# 2. 保存原始 JSON
- 保存为 data_YYYYMMDD_HHMMSS.json（带时间戳）
- 同时保存为 latest.json（覆盖）
- 确保数据完整性，即使数据库处理失败也能恢复
```

### 2. 修改 `storage.py` - 增强数据检查日志

**位置**：`teacherserver/storage.py` 的 `save_student_data()` 方法

**修改内容**：
- ✅ 在保存到数据库前检查原始数据
- ✅ 详细记录 `_raw_data` 中的 `stages` 信息
- ✅ 统计媒体文件总数
- ✅ 如果缺少 `stages` 字段，记录警告日志

## 📋 数据流程

### 修复后的完整流程

1. **Android 端发送数据**
   ```
   POST /api/submit
   {
     "processRecord": {
       "stages": {
         "PREPARATION": {
           "mediaItems": [...]
         }
       }
     }
   }
   ```

2. **服务器端接收并立即保存**
   ```
   ✅ 检查数据格式
   ✅ 保存原始 JSON 到文件（data_*.json 和 latest.json）
   ✅ 记录详细日志
   ```

3. **解析并保存到数据库**
   ```
   ✅ 从 _raw_data 提取 stages
   ✅ 提取 mediaItems
   ✅ 保存到 stage_records 和 media_items 表
   ```

## 🔍 验证方法

### 1. 查看服务器日志

当学生提交数据时，应该看到类似日志：

```
============================================================
收到学生数据提交
学生ID: 广雅_高一_4班_1号炉
数据键: ['teamInfo', 'processRecord', 'teamDivision', 'exportTime']
✅ processRecord 存在
   processRecord 的键: ['startTime', 'endTime', 'currentStage', 'overallNotes', 'stages']
   包含 stages 字段: True
   stages 数量: 7
      阶段 PREPARATION: 2 个媒体文件
      阶段 FIRE_MAKING: 1 个媒体文件
   总计: 3 个媒体文件
============================================================
✅ 已保存原始 JSON 数据: data/students/广雅_高一_4班_1号炉/data_20260103_121500.json
   包含 stages: True
🔍 开始保存学生数据到数据库: 广雅_高一_4班_1号炉
   原始数据检查:
     processRecord 存在: True
     包含 stages 字段: True
     stages 数量: 7
     总计媒体文件: 3
```

### 2. 检查 JSON 文件

```bash
cd teacherserver
python debug_media_data.py
```

应该看到：
- ✅ JSON 文件中包含 `stages` 字段
- ✅ 每个阶段包含 `mediaItems` 数组
- ✅ 数据库 `media_items` 表中有记录

### 3. 检查数据库

```bash
# 使用 SQLite 工具查看
sqlite3 data/campcooking.db

# 查询媒体文件
SELECT COUNT(*) FROM media_items;
SELECT sr.stage_name, COUNT(mi.id) as media_count
FROM stage_records sr
LEFT JOIN media_items mi ON sr.id = mi.stage_record_id
GROUP BY sr.stage_name;
```

## 🎯 关键改进

### 问题根源
- ❌ **之前**：服务器端只保存到数据库，不保存原始 JSON
- ❌ **之前**：如果 Android 端没有发送 `stages`，数据就丢失了
- ❌ **之前**：无法从 JSON 文件恢复完整数据

### 解决方案
- ✅ **现在**：立即保存原始 JSON 到文件系统
- ✅ **现在**：即使数据库处理失败，也能从 JSON 恢复
- ✅ **现在**：详细的日志帮助排查问题
- ✅ **现在**：可以验证 Android 端是否正确发送数据

## 📝 下一步操作

1. **重启服务器**
   ```bash
   cd teacherserver
   python app.py
   ```

2. **从 Android 端重新提交数据**
   - 确保 Android 应用已更新（包含修复）
   - 拍摄照片/视频
   - 点击"保存并发送"

3. **查看日志**
   - 检查是否包含 `stages` 字段
   - 检查媒体文件数量是否正确

4. **验证数据**
   ```bash
   python debug_media_data.py
   ```

## ⚠️ 注意事项

1. **JSON 文件位置**：
   - 带时间戳：`data/students/{student_id}/data_YYYYMMDD_HHMMSS.json`
   - 最新版本：`data/students/{student_id}/latest.json`

2. **日志级别**：
   - 确保日志级别设置为 INFO 或 DEBUG
   - 在 `app.py` 中已配置为 INFO

3. **数据完整性**：
   - 现在 JSON 文件包含完整数据（包括 `stages`）
   - 即使数据库处理有问题，也能从 JSON 恢复

## 🐛 如果问题仍然存在

如果 `media_items` 表仍然是空的，请检查：

1. **Android 端是否正确发送数据**
   - 查看 Android Logcat 日志
   - 确认 `convertProcessRecordToMap` 生成了 `stages`

2. **服务器端日志**
   - 查看是否显示"包含 stages 字段: True"
   - 查看是否有错误信息

3. **JSON 文件内容**
   - 打开 `latest.json` 文件
   - 检查是否包含 `stages` 字段

4. **数据库保存过程**
   - 查看 `storage.py` 和 `db_manager.py` 的日志
   - 确认媒体文件是否被正确提取和保存

---

**修复完成时间**：2026-01-03
**修复内容**：保存原始 JSON 数据 + 增强日志记录

