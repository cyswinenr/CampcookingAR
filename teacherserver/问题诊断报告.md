# 媒体文件数据问题诊断报告

## 🔍 问题确认

### 诊断结果

通过检查所有 JSON 文件发现：
- ❌ **所有 7 个 JSON 文件都没有 `stages` 字段**
- ❌ `processRecord` 只有：`['startTime', 'endTime', 'currentStage', 'overallNotes']`
- ✅ 数据库中有 `stage_records` 记录（说明服务器端处理了数据）
- ❌ 但 `media_items` 表是空的（因为没有 `stages` 数据）

### 关键发现

1. **Android 端代码已修复**：
   - ✅ `DataSubmitManager.kt` 中已包含 `"stages" to stagesMap`
   - ✅ 代码逻辑正确，即使 `stages` 为空也会包含字段

2. **但实际发送的数据没有 `stages`**：
   - 说明 Android 应用**还没有重新编译运行修复后的代码**
   - 或者提交时使用的是旧版本的代码

3. **从 JSON 数据看**：
   - `currentStage: "SHOWCASE"` - 说明学生已经访问过多个阶段
   - 但 `stages` 字段不存在 - 说明旧代码没有发送这个字段

## 🎯 问题根源

**Android 应用还没有重新编译运行修复后的代码！**

即使代码已经修复，如果应用没有重新编译和安装，提交数据时仍然使用的是旧代码。

## ✅ 解决方案

### 步骤 1：重新编译 Android 应用

1. **在 Android Studio 中**：
   ```
   Build -> Rebuild Project
   ```

2. **或者使用 Gradle**：
   ```bash
   cd app
   ./gradlew clean
   ./gradlew assembleDebug
   ```

3. **安装到设备**：
   - 在 Android Studio 中点击 Run
   - 或者使用 `adb install` 安装 APK

### 步骤 2：清除旧数据（可选但推荐）

为了确保使用新代码，建议清除应用数据：

1. **在 Android 设备上**：
   - 设置 -> 应用 -> 找到应用 -> 清除数据

2. **或者重新输入团队信息**：
   - 确保使用新版本的应用逻辑

### 步骤 3：重新提交数据

1. **在 Android 应用中**：
   - 输入团队信息
   - 进入记录页面
   - 访问几个阶段（确保 `stages` 不为空）
   - 拍摄照片/视频
   - 点击"保存并发送"

2. **检查 Android Logcat**：
   应该看到类似日志：
   ```
   D/DataSubmitManager: ✅ 过程记录包含 7 个阶段
   D/DataSubmitManager:   阶段 PREPARATION: 2 个媒体文件
   D/DataSubmitManager: 转换过程记录: stages数量=7, 总阶段数=7
   ```

3. **检查服务器日志**：
   应该看到：
   ```
   ============================================================
   收到学生数据提交
   包含 stages 字段: True
   stages 数量: 7
   ============================================================
   ✅ 已保存原始 JSON 数据
   ```

### 步骤 4：验证数据

运行诊断脚本：
```bash
cd teacherserver
python debug_media_data.py
```

应该看到：
- ✅ JSON 文件中包含 `stages` 字段
- ✅ 每个阶段包含 `mediaItems` 数组
- ✅ 数据库 `media_items` 表中有记录

## 📋 代码修复确认

### Android 端修复（已完成）

**文件**：`app/src/main/java/com/campcooking/ar/utils/DataSubmitManager.kt`

```kotlin
// 第 266 行：确保 stages 字段始终存在
"stages" to stagesMap,  // 即使为空也要包含

// 第 272 行：调试日志
Log.d(TAG, "转换过程记录: stages数量=${stagesMap.size}, 总阶段数=${processRecord.stages.size}")
```

### 服务器端修复（已完成）

**文件**：`teacherserver/app.py`
- ✅ 立即保存原始 JSON 数据
- ✅ 详细日志记录

**文件**：`teacherserver/storage.py`
- ✅ 从 `_raw_data` 提取 `stages`
- ✅ 详细日志记录

## ⚠️ 重要提示

### 为什么需要重新编译？

1. **Kotlin 代码需要编译**：
   - 修改的 `.kt` 文件需要编译成 `.class` 文件
   - 然后打包成 APK

2. **应用需要重新安装**：
   - 即使编译了，也需要安装到设备
   - 旧版本的应用仍然在运行

3. **数据提交使用运行时的代码**：
   - 提交数据时使用的是设备上安装的应用版本
   - 不是 Android Studio 中的源代码

### 如何确认应用已更新？

1. **检查应用版本号**：
   - 在 Android Studio 中修改版本号
   - 或者在应用中显示版本号

2. **检查 Logcat 日志**：
   - 新版本会输出修复后的日志
   - 如果看到 "✅ 过程记录包含 X 个阶段"，说明是新版本

3. **检查服务器日志**：
   - 新版本提交的数据会包含 `stages` 字段
   - 服务器日志会显示 "包含 stages 字段: True"

## 🐛 如果重新编译后仍然没有 stages

如果重新编译并提交数据后，仍然没有 `stages` 字段，请检查：

1. **Android Logcat 日志**：
   - 查看是否显示 "转换过程记录: stages数量=X"
   - 如果 stages数量=0，说明 `processRecord.stages` 是空的

2. **检查 `processRecord.stages` 是否为空**：
   - 如果学生没有访问过任何阶段，`stages` Map 就是空的
   - 但即使为空，也应该包含 `"stages": {}` 字段

3. **检查 Gson 序列化**：
   - 确认 Gson 是否正确序列化了 `stages` 字段
   - 检查是否有自定义序列化器影响了结果

## 📝 总结

**问题根源**：Android 应用还没有重新编译运行修复后的代码

**解决方案**：
1. ✅ 重新编译 Android 应用
2. ✅ 安装到设备
3. ✅ 重新提交数据
4. ✅ 验证数据

**预期结果**：
- ✅ JSON 文件包含 `stages` 字段
- ✅ 数据库 `media_items` 表有数据
- ✅ 媒体文件信息正确保存

---

**诊断时间**：2026-01-03
**状态**：等待 Android 应用重新编译和提交数据

