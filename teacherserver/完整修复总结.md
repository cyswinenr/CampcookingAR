# 媒体文件数据完整修复总结

## 🎯 问题总结

### 问题 1：media_items 表为空
- **原因**：Android 端发送的数据缺少 `stages` 字段
- **状态**：✅ 已修复（Android 端代码已修复，需要重新编译）

### 问题 2：照片无法显示
- **原因**：Android 端只发送文件路径，没有上传实际文件
- **状态**：✅ 已修复（添加了文件上传功能）

## ✅ 已完成的修复

### 1. Android 端修复

**文件**：`app/src/main/java/com/campcooking/ar/utils/DataSubmitManager.kt`

**修复内容**：
- ✅ 确保 `stages` 字段始终存在
- ✅ 确保 `mediaItems` 字段始终存在
- ✅ **新增**：文件上传功能
- ✅ **新增**：在提交数据前先上传所有媒体文件
- ✅ 添加详细的调试日志

**关键代码**：
```kotlin
// 1. 收集所有媒体文件
val mediaFilesToUpload = mutableListOf<MediaItem>()
processRecord.stages.values.forEach { stageRecord ->
    mediaFilesToUpload.addAll(stageRecord.mediaItems)
}

// 2. 上传文件
for (mediaItem in mediaFilesToUpload) {
    uploadMediaFile(serverUrl, studentId, mediaItem, file)
}

// 3. 然后提交 JSON 数据
```

### 2. 服务器端修复

#### 2.1 文件上传接口

**文件**：`teacherserver/app.py`

**新增接口**：`POST /api/student/<student_id>/media/upload`

**功能**：
- 接收 multipart/form-data 格式的文件
- 保存到 `data/media/{student_id}/` 目录
- 更新数据库中的文件路径

#### 2.2 文件路径查找优化

**文件**：`teacherserver/storage.py`

**改进**：
- 从完整路径中提取文件名
- 在多个位置查找文件
- 从数据库查找对应的文件路径
- 添加详细的调试日志

#### 2.3 数据保存增强

**文件**：`teacherserver/storage.py` 和 `teacherserver/db_manager.py`

**改进**：
- 详细的日志记录
- 改进错误处理
- 确保数据完整性

## 📋 完整数据流程

### 修复后的完整流程

```
1. Android 端拍摄照片/视频
   ↓
2. 保存到本地（Android设备）
   ↓
3. 用户点击"保存并发送"
   ↓
4. Android 端收集所有媒体文件
   ↓
5. 逐个上传文件到服务器
   POST /api/student/{id}/media/upload
   ↓
6. 服务器保存文件
   保存到: data/media/{student_id}/{filename}
   更新数据库路径
   ↓
7. 提交 JSON 数据
   POST /api/submit
   {
     "processRecord": {
       "stages": {
         "PREPARATION": {
           "mediaItems": [
             {
               "path": "photo.jpg",  // 只是文件名
               "type": "PHOTO",
               "timestamp": 1234567890
             }
           ]
         }
       }
     }
   }
   ↓
8. 服务器保存到数据库
   保存到 media_items 表
   ↓
9. Web 界面显示照片
   GET /api/student/{id}/media/{filename}
   -> 从 data/media/{id}/{filename} 读取
```

## 🔧 技术细节

### 文件上传格式

**请求格式**：`multipart/form-data`

**字段**：
- `file`: 实际文件（二进制数据）
- `original_path`: Android 设备上的原始路径
- `type`: PHOTO 或 VIDEO
- `timestamp`: 时间戳

**响应格式**：
```json
{
  "status": "success",
  "filename": "photo.jpg",
  "message": "文件上传成功"
}
```

### 文件存储位置

**服务器端**：
```
teacherserver/data/media/
  └── {student_id}/
      ├── photo1.jpg
      ├── photo2.jpg
      └── video1.mp4
```

**数据库**：
```sql
media_items 表：
- file_path: "photo1.jpg"  (只是文件名)
- file_type: "PHOTO"
- stage_record_id: 123
```

### 文件访问

**Web 界面**：
```html
<img src="/api/student/{id}/media/photo1.jpg">
```

**服务器端查找顺序**：
1. `data/media/{student_id}/photo1.jpg`
2. `data/media/photo1.jpg`
3. `data/students/{student_id}/photo1.jpg`
4. 从数据库查找对应的路径

## 📝 使用步骤

### 1. 重新编译 Android 应用

```bash
# 在 Android Studio 中
Build -> Rebuild Project
```

### 2. 安装到设备

- 在 Android Studio 中点击 Run
- 或使用 `adb install`

### 3. 测试功能

1. **拍摄照片/视频**：
   - 在记录页面拍摄几张照片
   - 拍摄一段视频

2. **提交数据**：
   - 点击"保存并发送"
   - 查看 Logcat，应该看到：
     ```
     D/DataSubmitManager: 开始上传 3 个媒体文件
     D/DataSubmitManager: ✅ 上传成功: photo1.jpg
     D/DataSubmitManager: 媒体文件上传完成: 成功 3, 失败 0
     ```

3. **检查服务器**：
   - 查看服务器日志
   - 检查文件是否上传成功
   - 在 Web 界面查看照片

### 4. 验证结果

```bash
# 检查文件是否存在
ls teacherserver/data/media/广雅_高一_4班_1号炉/

# 检查数据库
python teacherserver/debug_media_data.py
```

## 🐛 故障排查

### 如果照片仍然无法显示

1. **检查文件是否上传**：
   ```bash
   ls teacherserver/data/media/{student_id}/
   ```

2. **检查服务器日志**：
   - 查看是否有上传成功的日志
   - 查看文件查找的详细日志

3. **检查浏览器控制台**：
   - 打开开发者工具
   - 查看 Network 标签
   - 检查 `/api/student/{id}/media/{filename}` 请求
   - 查看响应状态码

4. **检查数据库路径**：
   ```sql
   SELECT file_path, file_type FROM media_items;
   ```

### 常见问题

**Q: 文件上传失败怎么办？**
A: 检查网络连接，查看服务器日志，可以重试提交数据。

**Q: 文件上传成功但无法显示？**
A: 检查文件路径是否正确，查看服务器日志中的文件查找过程。

**Q: 数据库中的路径是完整路径怎么办？**
A: 文件上传接口会自动更新数据库路径，或者可以手动更新。

## 📊 预期效果

### 修复前
- ❌ `media_items` 表为空
- ❌ JSON 文件没有 `stages` 字段
- ❌ 照片图标显示但无法加载
- ❌ 文件在 Android 设备上，服务器无法访问

### 修复后
- ✅ `media_items` 表有数据
- ✅ JSON 文件包含 `stages` 字段
- ✅ 照片可以正常显示
- ✅ 文件保存在服务器上
- ✅ 数据库路径正确

## ⚠️ 重要提示

1. **必须重新编译 Android 应用**：
   - 代码已修复，但需要重新编译才能生效
   - 旧版本的应用仍然使用旧代码

2. **文件上传需要时间**：
   - 大文件上传可能需要较长时间
   - 确保网络连接稳定

3. **数据库路径更新**：
   - 文件上传后会自动更新数据库路径
   - 如果上传失败，路径仍然是 Android 路径

---

**修复完成时间**：2026-01-03
**修复内容**：
1. Android 端：文件上传功能 + stages 字段修复
2. 服务器端：文件上传接口 + 路径查找优化 + 详细日志

