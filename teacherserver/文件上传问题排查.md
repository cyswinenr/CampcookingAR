# 文件上传问题排查指南

## 🔍 当前问题

**现象**：
- ✅ 数据库中有媒体文件记录（2条）
- ❌ 但路径是Android设备路径（`/storage/emulated/0/...`）
- ❌ 服务器上没有上传的文件（`data/media/` 目录为空）
- ❌ Web界面显示"文件不存在"

**诊断结果**：
```
[数据库] media_items 表记录数: 2
  Android路径: 2条
  服务器路径: 0条

[文件系统] 上传目录: data/media
  [WARN] 没有学生目录
```

## 🎯 问题根源

**文件上传功能没有执行**，可能的原因：

1. **Android应用未重新编译**
   - 代码已修复，但应用还在使用旧版本
   - 旧版本没有文件上传功能

2. **上传功能执行失败**
   - 网络问题
   - 服务器接口问题
   - 文件权限问题

3. **上传请求未发送**
   - 代码逻辑问题
   - 异常被捕获但未记录

## ✅ 解决方案

### 方案1：重新编译Android应用（推荐）

**步骤**：

1. **在Android Studio中**：
   ```
   Build -> Rebuild Project
   ```

2. **安装到设备**：
   - 点击 Run 按钮
   - 或使用 `adb install`

3. **清除应用数据**（可选但推荐）：
   - 设置 -> 应用 -> 找到应用 -> 清除数据
   - 确保使用新版本逻辑

4. **重新提交数据**：
   - 拍摄照片/视频
   - 点击"保存并发送"
   - 查看Android Logcat日志

**预期日志**：
```
D/DataSubmitManager: 开始上传 2 个媒体文件
D/DataSubmitManager: 上传文件: photo.jpg (2048576 字节) 到 http://...
D/DataSubmitManager: ✅ 上传成功: photo.jpg
D/DataSubmitManager: 媒体文件上传完成: 成功 2, 失败 0
```

**服务器日志**：
```
✅ 上传媒体文件成功: 学生ID/photo.jpg
   原始路径: /storage/emulated/0/.../photo.jpg
   文件类型: PHOTO
   文件大小: 2048576 字节
   已更新数据库路径: /storage/... -> photo.jpg
```

### 方案2：检查上传功能

**检查Android Logcat**：

1. 打开Android Studio
2. 连接设备
3. 在Logcat中过滤 `DataSubmitManager`
4. 提交数据时查看日志

**应该看到**：
- `开始上传 X 个媒体文件`
- `上传文件: ...`
- `✅ 上传成功` 或 `⚠️ 上传失败`

**如果没有看到这些日志**：
- 说明上传功能没有执行
- 可能是应用未重新编译

### 方案3：手动验证上传接口

**测试服务器接口**：

```bash
# 使用curl测试上传接口
curl -X POST http://192.168.3.17:5000/api/student/测试_高二_1班_2号炉/media/upload \
  -F "file=@test.jpg" \
  -F "original_path=/storage/emulated/0/test.jpg" \
  -F "type=PHOTO" \
  -F "timestamp=1234567890"
```

**预期响应**：
```json
{
  "status": "success",
  "filename": "test.jpg",
  "message": "文件上传成功"
}
```

### 方案4：检查服务器日志

**查看服务器日志**：

1. 检查是否有上传请求：
   ```
   grep "上传媒体文件" app.log
   ```

2. 检查是否有错误：
   ```
   grep "ERROR" app.log | grep -i upload
   ```

3. 检查文件是否保存：
   ```bash
   ls -la data/media/
   ```

## 🐛 常见问题

### Q1: 为什么数据库路径还是Android路径？

**A**: 因为文件上传功能没有执行。上传成功后，服务器会自动更新数据库路径。

### Q2: 如何确认应用已重新编译？

**A**: 
1. 检查应用版本号（如果代码中有）
2. 查看Logcat日志，新版本会输出上传相关的日志
3. 检查服务器日志，新版本提交的数据会触发上传请求

### Q3: 上传失败怎么办？

**A**: 
1. 检查网络连接
2. 检查服务器是否运行
3. 查看服务器日志中的错误信息
4. 检查文件权限

### Q4: 如何手动更新数据库路径？

**A**: 
```sql
-- 更新所有Android路径为文件名
UPDATE media_items 
SET file_path = SUBSTR(file_path, INSTR(file_path, '/') + 1)
WHERE file_path LIKE '/storage/%';

-- 或者使用Python脚本
python update_media_paths.py
```

## 📋 验证步骤

### 1. 检查上传状态

```bash
cd teacherserver
python check_upload_status.py
```

### 2. 检查文件是否存在

```bash
ls -la data/media/
```

### 3. 检查数据库路径

```sql
SELECT file_path, file_type FROM media_items;
```

### 4. 测试Web界面

- 打开浏览器
- 访问服务器Web界面
- 查看学生详情
- 检查照片是否能显示

## ⚠️ 重要提示

1. **必须重新编译Android应用**
   - 代码已修复，但需要重新编译才能生效
   - 旧版本的应用仍然使用旧代码

2. **上传需要时间**
   - 大文件上传可能需要较长时间
   - 确保网络连接稳定

3. **检查日志**
   - Android Logcat日志
   - 服务器日志
   - 两者都要检查

---

**最后更新**：2026-01-03
**状态**：等待Android应用重新编译和上传文件

