# 媒体文件存储说明

## 问题分析

### 当前情况
1. **数据库状态**：
   - `stage_records` 表有 7 条记录（7个阶段）
   - `media_items` 表有 0 条记录（没有媒体文件信息）

2. **JSON 文件状态**：
   - JSON 文件中的 `processRecord` 没有包含 `stages` 字段
   - 因此没有媒体文件信息被传递到服务器

### 问题根源

从 JSON 文件 `data_20260103_104732.json` 可以看到：
```json
{
  "processRecord": {
    "startTime": 1767407901561,
    "endTime": null,
    "currentStage": "FIRE_MAKING",
    "overallNotes": ""
  }
}
```

**缺少 `stages` 字段**，而 `stages` 字段中应该包含每个阶段的 `mediaItems` 数据。

Android 端的 `DataSubmitManager.kt` 中有正确的代码将 `mediaItems` 转换为 JSON：
```kotlin
"mediaItems" to stageRecord.mediaItems.map { mediaItem ->
    mapOf(
        "path" to mediaItem.path,
        "type" to mediaItem.type.name,
        "timestamp" to mediaItem.timestamp
    )
}
```

但实际发送的数据中没有包含这些信息，可能的原因：
1. 学生还没有拍摄照片/视频
2. 或者 `processRecord.stages` 为空
3. 或者数据导出时没有正确包含 stages 数据

---

## SQLite 如何存储图片和视频

### 设计原则

**SQLite 不直接存储二进制文件（图片、视频）**，而是存储**文件路径**。这是最佳实践：

1. **性能考虑**：
   - SQLite 数据库文件会变得非常大
   - 查询和备份会很慢
   - 数据库文件损坏风险增加

2. **存储方式**：
   - 实际文件存储在文件系统中（`teacherserver/data/media/`）
   - 数据库中只存储文件路径、类型、大小等元数据

### 数据库表结构

`media_items` 表的设计：

```sql
CREATE TABLE media_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stage_record_id INTEGER,           -- 关联到阶段记录
    summary_question INTEGER,           -- 关联到课后总结问题（1,2,3）
    file_path TEXT NOT NULL,            -- 文件路径（不是二进制数据！）
    file_type TEXT NOT NULL,            -- PHOTO 或 VIDEO
    file_size INTEGER,                 -- 文件大小（字节）
    timestamp INTEGER NOT NULL,         -- 拍摄时间戳
    created_at INTEGER NOT NULL,
    schema_version INTEGER NOT NULL DEFAULT 1,
    extra_data TEXT                     -- JSON字段，可存储缩略图路径、视频时长等
);
```

### 存储示例

假设学生拍摄了一张照片，存储方式如下：

1. **文件系统**：
   ```
   teacherserver/data/media/广雅_高一_4班_1号炉/photo_20260103_104732.jpg
   ```

2. **数据库记录**：
   ```sql
   INSERT INTO media_items (
       stage_record_id, 
       file_path, 
       file_type, 
       file_size, 
       timestamp
   ) VALUES (
       123,  -- stage_record_id
       'photo_20260103_104732.jpg',  -- 文件名（相对路径）
       'PHOTO',
       2048576,  -- 2MB
       1767408454050  -- 时间戳
   );
   ```

### 文件路径说明

- **相对路径**：只存储文件名，完整路径通过 `student_id` 和 `media_dir` 拼接
- **完整路径**：`{media_dir}/{student_id}/{file_path}`

---

## 解决方案

### 1. 检查 Android 端数据

确保 Android 端在提交数据时包含 `stages` 字段：

```kotlin
// DataSubmitManager.kt 中的 convertProcessRecordToMap 方法
// 应该生成包含 stages 的数据结构
{
  "processRecord": {
    "startTime": ...,
    "endTime": ...,
    "currentStage": ...,
    "stages": {
      "PREPARATION": {
        "stage": "PREPARATION",
        "startTime": ...,
        "mediaItems": [
          {
            "path": "/storage/emulated/0/.../photo.jpg",
            "type": "PHOTO",
            "timestamp": 1767408454050
          }
        ],
        ...
      },
      "FIRE_MAKING": {
        ...
      }
    }
  }
}
```

### 2. 服务器端处理流程

服务器端在 `storage.py` 中的处理逻辑：

```python
# 1. 从原始数据中提取 stages
if hasattr(data_package, '_raw_data') and data_package._raw_data:
    process_data = data_package._raw_data.get('processRecord')
    if process_data and 'stages' in process_data:
        stages_dict = process_data.get('stages', {})
        for stage_name, stage_data in stages_dict.items():
            stage = StageRecord(stage_data)
            stages.append(stage)
            # 提取媒体文件
            if 'mediaItems' in stage_data:
                stages_media[stage_name] = stage_data['mediaItems']
```

### 3. 保存到数据库

在 `db_manager.py` 中保存媒体文件：

```python
# 保存该阶段的媒体文件
if stages_media and stage.stage_name in stages_media:
    media_items = stages_media[stage.stage_name]
    for media_data in media_items:
        media_item = MediaItem(media_data)
        media_item.stage_record_id = stage.id
        # 插入到 media_items 表
        self._execute("""
            INSERT INTO media_items (
                stage_record_id, file_path, file_type,
                file_size, timestamp, ...
            ) VALUES (?, ?, ?, ?, ?, ...)
        """, (...))
```

---

## 验证步骤

### 1. 检查 JSON 文件

查看学生提交的 JSON 文件，确认是否包含 `stages` 字段：

```bash
# 查看 JSON 文件
cat teacherserver/data/students/广雅_高一_4班_1号炉/data_*.json | jq '.processRecord.stages'
```

### 2. 检查数据库

```bash
# 运行检查脚本
cd teacherserver
python check_media.py
```

### 3. 检查文件系统

```bash
# 查看媒体文件目录
ls -la teacherserver/data/media/
```

---

## 总结

1. **SQLite 存储方式**：
   - ✅ 存储文件路径（`file_path`）
   - ✅ 存储文件元数据（类型、大小、时间戳）
   - ❌ 不存储二进制数据

2. **当前问题**：
   - Android 端提交的数据缺少 `stages` 字段
   - 因此没有媒体文件信息被保存到数据库

3. **解决方案**：
   - 确保 Android 端在提交数据时包含完整的 `stages` 数据
   - 或者检查学生是否真的拍摄了照片/视频

