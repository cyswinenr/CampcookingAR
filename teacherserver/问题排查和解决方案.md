# 媒体文件数据问题排查和解决方案

## 问题确认

通过调试脚本 `debug_media_data.py` 检查发现：

### 当前状态

1. **JSON 文件状态**：
   - ❌ `processRecord` 中没有 `stages` 字段
   - ✅ `processRecord` 只有：`['startTime', 'endTime', 'currentStage', 'overallNotes']`

2. **数据库状态**：
   - ❌ `media_items` 表：0 条记录
   - ✅ `stage_records` 表：7 条记录（但都没有媒体文件）

### 问题根源

**Android 端提交的数据中缺少 `stages` 字段**，导致服务器端无法提取媒体文件信息。

可能的原因：
1. Android 应用还没有重新编译和运行（修复代码后）
2. 学生还没有重新提交数据
3. 或者提交时 `processRecord.stages` 为空

---

## 解决方案

### 步骤 1：确认 Android 端修复已生效

1. **重新编译 Android 应用**：
   ```bash
   # 在 Android Studio 中
   Build -> Rebuild Project
   ```

2. **检查代码**：
   确认 `DataSubmitManager.kt` 中的 `convertProcessRecordToMap` 方法已更新，包含：
   - ✅ 确保 `stages` 字段始终存在
   - ✅ 确保 `mediaItems` 字段始终存在
   - ✅ 添加了调试日志

3. **运行应用并测试**：
   - 拍摄几张照片
   - 拍摄一段视频
   - 点击"保存并发送"按钮
   - 查看 Logcat 输出，确认日志显示：
     ```
     D/DataSubmitManager: ✅ 过程记录包含 X 个阶段
     D/DataSubmitManager:   阶段 XXX: X 个媒体文件
     ```

### 步骤 2：重新提交数据

1. **在 Android 应用中**：
   - 确保已经拍摄了照片/视频
   - 点击"保存并发送"按钮
   - 等待提交成功提示

2. **检查服务器端日志**：
   查看服务器端日志，应该看到：
   ```
   INFO: 处理过程记录数据: process_data存在=True
   INFO: 找到stages数据: 7 个阶段
   INFO:   阶段 PREPARATION: 2 个媒体文件
   INFO: 准备保存: 7 个阶段记录, 3 个阶段有媒体文件
   ```

### 步骤 3：验证数据

运行调试脚本：
```bash
cd teacherserver
python debug_media_data.py
```

应该看到：
- ✅ JSON 文件中包含 `stages` 字段
- ✅ 每个阶段包含 `mediaItems` 数组
- ✅ 数据库 `media_items` 表中有记录

---

## 已完成的修复

### 1. Android 端修复

**文件**：`app/src/main/java/com/campcooking/ar/utils/DataSubmitManager.kt`

- ✅ 确保 `stages` 字段始终存在（即使为空）
- ✅ 确保 `mediaItems` 字段始终存在（即使为空数组）
- ✅ 添加详细的调试日志

### 2. 服务器端修复

**文件**：`teacherserver/storage.py`

- ✅ 添加详细的日志，记录数据提取过程
- ✅ 记录每个阶段的媒体文件数量
- ✅ 记录媒体文件的详细信息

**文件**：`teacherserver/db_manager.py`

- ✅ 添加详细的日志，记录保存过程
- ✅ 记录每个媒体文件的保存状态
- ✅ 改进错误处理

**文件**：`teacherserver/models.py`

- ✅ 修复 `MediaItem.from_dict` 方法
- ✅ 确保 `timestamp` 有默认值
- ✅ 确保 `type` 字段正确处理

---

## 调试工具

### 使用调试脚本

```bash
cd teacherserver
python debug_media_data.py
```

这个脚本会：
1. 检查 JSON 文件中是否包含 `stages` 数据
2. 统计每个阶段的媒体文件数量
3. 检查数据库中的媒体文件记录

### 查看服务器日志

服务器端现在会输出详细的日志：
- 数据接收和处理过程
- 每个阶段的媒体文件提取情况
- 数据库保存状态

---

## 下一步操作

1. **重新编译 Android 应用**（如果还没有）
2. **重新提交数据**（确保包含照片/视频）
3. **运行调试脚本**验证数据
4. **查看服务器日志**确认处理过程

如果问题仍然存在，请：
1. 检查 Android 端 Logcat 输出
2. 检查服务器端日志
3. 运行 `debug_media_data.py` 查看详细状态

---

## 预期结果

修复后，应该看到：

### JSON 文件格式
```json
{
  "processRecord": {
    "startTime": ...,
    "endTime": ...,
    "currentStage": ...,
    "overallNotes": ...,
    "stages": {  // ✅ 现在应该存在
      "PREPARATION": {
        "mediaItems": [  // ✅ 现在应该存在
          {
            "path": "/path/to/photo.jpg",
            "type": "PHOTO",
            "timestamp": 1234567890
          }
        ],
        ...
      },
      ...
    }
  }
}
```

### 数据库状态
- ✅ `media_items` 表中有记录
- ✅ 每个阶段记录关联了媒体文件
- ✅ 可以通过 `stage_record_id` 查询媒体文件

---

## 注意事项

1. **数据格式**：
   - Android 端发送的 `type` 字段应该是字符串 "PHOTO" 或 "VIDEO"
   - `timestamp` 应该是毫秒级时间戳

2. **文件路径**：
   - 数据库中只存储文件路径（相对路径或文件名）
   - 实际文件存储在文件系统中

3. **空数据处理**：
   - 即使没有媒体文件，`stages` 和 `mediaItems` 字段也会存在（为空对象/数组）
   - 这确保了数据结构的完整性

