# 照片显示问题修复说明

## 🔍 问题分析

### 问题现象
- ✅ 服务器端可以看到照片图标
- ❌ 但无法正确显示照片

### 根本原因

1. **文件路径问题**：
   - Android 端发送的文件路径是设备上的完整路径：`/storage/emulated/0/Android/data/.../photo.jpg`
   - 这些文件在 Android 设备上，**不在服务器上**
   - 服务器端尝试查找文件，但找不到

2. **缺少文件上传功能**：
   - 当前系统只发送文件路径，**没有上传实际文件**
   - 服务器无法访问 Android 设备上的文件

## ✅ 解决方案

### 1. 服务器端：添加文件上传接口

**新增接口**：`POST /api/student/<student_id>/media/upload`

**功能**：
- 接收 multipart/form-data 格式的文件上传
- 保存文件到 `data/media/{student_id}/` 目录
- 更新数据库中的文件路径

**文件位置**：`teacherserver/app.py`

### 2. Android 端：添加文件上传功能

**修改文件**：`app/src/main/java/com/campcooking/ar/utils/DataSubmitManager.kt`

**功能**：
- 在提交数据前，先上传所有媒体文件
- 使用 multipart/form-data 格式上传
- 支持照片和视频

**上传流程**：
1. 收集所有需要上传的媒体文件
2. 逐个上传到服务器
3. 上传完成后，再提交 JSON 数据

### 3. 增强文件路径查找

**修改文件**：`teacherserver/storage.py` 的 `get_media_file_path` 方法

**改进**：
- 从完整路径中提取文件名
- 在多个位置查找文件
- 从数据库查找对应的文件路径
- 添加详细的调试日志

## 📋 完整流程

### 修复后的数据提交流程

1. **Android 端收集媒体文件**
   ```
   从 processRecord.stages 中收集所有 mediaItems
   ```

2. **上传媒体文件到服务器**
   ```
   POST /api/student/{student_id}/media/upload
   Content-Type: multipart/form-data
   - file: 实际文件
   - original_path: Android设备路径
   - type: PHOTO/VIDEO
   - timestamp: 时间戳
   ```

3. **服务器保存文件**
   ```
   保存到: data/media/{student_id}/{filename}
   更新数据库: 将原始路径更新为服务器端路径
   ```

4. **提交 JSON 数据**
   ```
   POST /api/submit
   {
     "processRecord": {
       "stages": {
         "PREPARATION": {
           "mediaItems": [
             {
               "path": "COOKING_20260103_122938.jpg",  // 现在只是文件名
               "type": "PHOTO",
               "timestamp": 1234567890
             }
           ]
         }
       }
     }
   }
   ```

5. **服务器端显示照片**
   ```
   GET /api/student/{student_id}/media/{filename}
   -> 从 data/media/{student_id}/{filename} 读取文件
   ```

## 🔧 技术实现

### 服务器端文件上传接口

```python
@app.route('/api/student/<student_id>/media/upload', methods=['POST'])
def upload_media_file(student_id: str):
    """上传媒体文件（照片/视频）"""
    file = request.files['file']
    original_path = request.form.get('original_path', '')
    file_type = request.form.get('type', 'PHOTO')
    
    # 保存文件
    student_media_dir = os.path.join(Config.MEDIA_DIR, student_id)
    safe_filename = os.path.basename(original_path)
    file_path = os.path.join(student_media_dir, safe_filename)
    file.save(file_path)
    
    # 更新数据库路径
    # ...
```

### Android 端文件上传

```kotlin
private fun uploadMediaFile(serverUrl: String, studentId: String, mediaItem: MediaItem, file: File): Boolean {
    val requestBody = MultipartBody.Builder()
        .setType(MultipartBody.FORM)
        .addFormDataPart("file", file.name, file.asRequestBody(mimeType.toMediaType()))
        .addFormDataPart("original_path", mediaItem.path)
        .addFormDataPart("type", mediaItem.type.name)
        .addFormDataPart("timestamp", mediaItem.timestamp.toString())
        .build()
    
    // 发送请求
    // ...
}
```

## 📝 使用说明

### 1. 重新编译 Android 应用

```bash
# 在 Android Studio 中
Build -> Rebuild Project
```

### 2. 重新提交数据

1. **在 Android 应用中**：
   - 拍摄照片/视频
   - 点击"保存并发送"
   - 应用会自动上传文件，然后提交数据

2. **查看上传日志**：
   ```
   D/DataSubmitManager: 开始上传 3 个媒体文件
   D/DataSubmitManager: ✅ 上传成功: photo1.jpg
   D/DataSubmitManager: 媒体文件上传完成: 成功 3, 失败 0
   ```

3. **查看服务器日志**：
   ```
   ✅ 上传媒体文件成功: 广雅_高一_4班_1号炉/photo1.jpg
      原始路径: /storage/emulated/0/.../photo1.jpg
      文件类型: PHOTO
      文件大小: 2048576 字节
   ```

### 3. 验证照片显示

1. **检查文件是否存在**：
   ```bash
   ls teacherserver/data/media/广雅_高一_4班_1号炉/
   ```

2. **在 Web 界面查看**：
   - 打开服务器 Web 界面
   - 查看学生详情
   - 照片应该能正常显示

## ⚠️ 注意事项

1. **文件大小限制**：
   - 默认超时时间：30秒
   - 大文件可能需要更长时间
   - 可以在 `DataSubmitManager` 中调整超时时间

2. **网络稳定性**：
   - 文件上传需要稳定的网络连接
   - 如果上传失败，会在日志中记录
   - 可以重试提交数据

3. **文件路径**：
   - 上传后，数据库中的路径会更新为服务器端路径（文件名）
   - 原始路径保存在 `original_path` 字段（如果数据库支持）

4. **向后兼容**：
   - 如果文件已经上传，直接使用文件名查找
   - 如果文件未上传，尝试从原始路径提取文件名

## 🐛 故障排查

### 如果照片仍然无法显示

1. **检查文件是否上传成功**：
   ```bash
   ls teacherserver/data/media/{student_id}/
   ```

2. **检查服务器日志**：
   - 查看是否有上传成功的日志
   - 查看是否有文件查找失败的日志

3. **检查数据库路径**：
   ```sql
   SELECT file_path FROM media_items WHERE stage_record_id = ?;
   ```

4. **检查 Web 界面请求**：
   - 打开浏览器开发者工具
   - 查看 Network 标签
   - 检查 `/api/student/{id}/media/{filename}` 请求
   - 查看响应状态码和错误信息

## 📊 预期效果

### 修复前
- ❌ 照片图标显示，但点击后无法加载
- ❌ 服务器日志显示"文件不存在"
- ❌ 文件在 Android 设备上，服务器无法访问

### 修复后
- ✅ 照片图标正常显示
- ✅ 点击后可以查看照片
- ✅ 文件保存在服务器上
- ✅ 数据库路径正确

---

**修复完成时间**：2026-01-03
**修复内容**：文件上传功能 + 路径查找优化

