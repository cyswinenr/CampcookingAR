# 测试阶段评分显示功能

## 🔍 验证步骤

### 1. 检查数据库中的数据

运行以下 Python 代码检查数据库中的评分数据：

```python
import sqlite3
from config import Config

db_path = Config.DATABASE_PATH
conn = sqlite3.connect(db_path)
conn.row_factory = sqlite3.Row
cursor = conn.cursor()

# 查询所有阶段的评分
cursor.execute("""
    SELECT 
        t.team_id,
        t.school,
        t.grade,
        t.class_name,
        t.stove_number,
        sr.stage_name,
        sr.self_rating,
        sr.is_completed
    FROM teams t
    LEFT JOIN process_records pr ON t.team_id = pr.team_id
    LEFT JOIN stage_records sr ON pr.id = sr.process_record_id
    ORDER BY t.stove_number, sr.stage_name
""")

rows = cursor.fetchall()
print("=" * 80)
print("数据库中的阶段评分数据：")
print("=" * 80)
for row in rows:
    if row['stage_name']:
        print(f"团队: {row['team_id']}")
        print(f"  阶段: {row['stage_name']}")
        print(f"  评分: {row['self_rating']} (类型: {type(row['self_rating'])})")
        print(f"  完成: {row['is_completed']}")
        print()

conn.close()
```

### 2. 检查 API 返回的数据

访问 `http://localhost:5000/api/students`，查看返回的 JSON 数据中是否包含 `stageRatings` 字段。

示例响应：
```json
{
  "status": "success",
  "students": [
    {
      "id": "广雅_高一_4班_1号炉",
      "stageRatings": {
        "PREPARATION": {
          "selfRating": 5,
          "isCompleted": true
        },
        "FIRE_MAKING": {
          "selfRating": 4,
          "isCompleted": true
        }
      }
    }
  ]
}
```

### 3. 检查前端控制台

打开浏览器开发者工具（F12），查看控制台输出：
- 应该能看到类似 `学生 xxx 的评分数据: {...}` 的日志
- 应该能看到每个阶段的评分信息

### 4. 验证显示效果

- ✅ 有评分的阶段应该显示实心星（★）和空心星（☆）
- ✅ 没有评分的阶段应该显示5个空星（☆☆☆☆☆）
- ✅ 有评分的阶段应该有橙色背景高亮

## 🐛 常见问题排查

### 问题1：所有阶段都显示空星

**可能原因：**
1. 数据库中没有评分数据
2. 数据读取逻辑有问题
3. 前端解析有问题

**解决方法：**
1. 运行上面的 Python 脚本检查数据库
2. 检查服务器日志，查看是否有错误
3. 检查浏览器控制台，查看是否有 JavaScript 错误

### 问题2：部分阶段显示不正确

**可能原因：**
1. 阶段名称不匹配（大小写、拼写）
2. 评分值超出范围（应该是 1-5）

**解决方法：**
1. 检查 `STAGE_ORDER` 和数据库中的 `stage_name` 是否一致
2. 检查评分值是否在有效范围内

### 问题3：数据没有更新

**可能原因：**
1. 浏览器缓存
2. API 缓存

**解决方法：**
1. 强制刷新页面（Ctrl+F5）
2. 检查 API 请求是否添加了时间戳参数

## 📝 调试日志位置

### 后端日志
- `storage.py`: 在 `get_all_students()` 方法中记录每个阶段的评分
- `app.py`: 在 `/api/students` 接口中记录评分数据
- `db_manager.py`: 在 `get_process_record()` 方法中记录从数据库读取的数据

### 前端日志
- 浏览器控制台：显示接收到的评分数据和每个阶段的评分值

## ✅ 预期结果

1. **数据库有评分数据时：**
   - 对应阶段显示实心星和空心星
   - 例如：5星显示 ★★★★★，3星显示 ★★★☆☆

2. **数据库没有评分数据时：**
   - 显示5个空星 ☆☆☆☆☆
   - 背景为灰色

3. **部分阶段有评分时：**
   - 有评分的阶段显示星星
   - 没有评分的阶段显示空星

---

**测试日期：** 2025-01-03

