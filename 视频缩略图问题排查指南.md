# ğŸ” è§†é¢‘ç¼©ç•¥å›¾é—®é¢˜æ’æŸ¥æŒ‡å—

## é—®é¢˜ç°è±¡
å½•åˆ¶è§†é¢‘åï¼Œçœ‹ä¸åˆ°è§†é¢‘ç¼©ç•¥å›¾

---

## âœ… å·²æ·»åŠ çš„è°ƒè¯•åŠŸèƒ½

### 1. è¯¦ç»†æ—¥å¿—è¾“å‡º
å·²æ·»åŠ Android Logcatæ—¥å¿—ï¼Œæ ‡ç­¾ä¸º `PhotoListAdapter`

### 2. ä¸‰ç§ç¼©ç•¥å›¾åŠ è½½æ–¹æ³•
- **æ–¹æ³•1:** ThumbnailUtilsï¼ˆç³»ç»Ÿæ–¹æ³•ï¼‰
- **æ–¹æ³•2:** MediaMetadataRetrieverï¼ˆå¸§æå–ï¼‰
- **æ–¹æ³•3:** ContentResolverï¼ˆMediaStoreæŸ¥è¯¢ï¼‰

### 3. æ”¹è¿›çš„é»˜è®¤ç¼©ç•¥å›¾
å³ä½¿æ‰€æœ‰æ–¹æ³•å¤±è´¥ï¼Œä¹Ÿä¼šæ˜¾ç¤ºå¸¦æ’­æ”¾å›¾æ ‡çš„ç°è‰²èƒŒæ™¯

---

## ğŸ”§ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæŸ¥çœ‹Logcatæ—¥å¿—

**åœ¨Android Studioä¸­ï¼š**
1. ç‚¹å‡»åº•éƒ¨çš„ **Logcat** æ ‡ç­¾
2. åœ¨æœç´¢æ¡†è¾“å…¥ï¼š`PhotoListAdapter`
3. å½•åˆ¶ä¸€ä¸ªè§†é¢‘
4. æŸ¥çœ‹æ—¥å¿—è¾“å‡º

**æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—ï¼š**
```
D/PhotoListAdapter: å¼€å§‹åŠ è½½è§†é¢‘ç¼©ç•¥å›¾: /path/to/video.mp4
D/PhotoListAdapter: æ–‡ä»¶å­˜åœ¨: true, å¤§å°: 1234567 bytes
D/PhotoListAdapter: å°è¯•æ–¹æ³•1: ThumbnailUtils
D/PhotoListAdapter: æ–¹æ³•1ç»“æœ: true  â† å¦‚æœè¿™è¡Œæ˜¯trueï¼Œè¯´æ˜æˆåŠŸ
D/PhotoListAdapter: æˆåŠŸåŠ è½½è§†é¢‘ç¼©ç•¥å›¾!
```

**å¦‚æœå¤±è´¥ï¼š**
```
D/PhotoListAdapter: æ–¹æ³•1ç»“æœ: false
D/PhotoListAdapter: å°è¯•æ–¹æ³•2: MediaMetadataRetriever
D/PhotoListAdapter: MediaMetadataRetrieverè·å–å¸§: false
D/PhotoListAdapter: å°è¯•æ–¹æ³•3: ContentResolver
D/PhotoListAdapter: æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç¼©ç•¥å›¾
```

---

### æ­¥éª¤2ï¼šæ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦çœŸçš„å­˜åœ¨

åœ¨Logcatä¸­æœç´¢ï¼š`è§†é¢‘æ–‡ä»¶`

**å¦‚æœçœ‹åˆ°ï¼š**
- âŒ `è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨!` - è¯´æ˜æ–‡ä»¶è·¯å¾„æœ‰é—®é¢˜
- âŒ `è§†é¢‘æ–‡ä»¶è¿‡å°: 5678 bytes` - è¯´æ˜å½•åˆ¶å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
æ£€æŸ¥ `RecordActivity.kt` ä¸­è§†é¢‘å½•åˆ¶å’Œä¿å­˜é€»è¾‘

---

### æ­¥éª¤3ï¼šæ£€æŸ¥RecyclerViewå¸ƒå±€

**å¯èƒ½çš„é—®é¢˜ï¼š** RecyclerViewæ²¡æœ‰æ­£ç¡®ç»‘å®š

**æ£€æŸ¥æ–¹æ³•ï¼š**
1. åœ¨RecordActivityçš„ `setupPhotosList()` æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—
2. æŸ¥çœ‹ `mediaItems` åˆ—è¡¨æ˜¯å¦æœ‰å†…å®¹

**æ·»åŠ æ—¥å¿—ï¼š**
```kotlin
private fun setupPhotosList() {
    val items = getCurrentStageRecord().mediaItems
    android.util.Log.d("RecordActivity", "åª’ä½“é¡¹æ•°é‡: ${items.size}")
    items.forEachIndexed { index, item ->
        android.util.Log.d("RecordActivity", "[$index] ç±»å‹: ${item.type}, è·¯å¾„: ${item.path}")
    }

    photoListAdapter = PhotoListAdapter(
        mediaItems = items,
        onViewClick = { mediaItem -> viewMedia(mediaItem) },
        onDeleteClick = { position -> showDeleteMediaDialog(position) }
    )

    binding.photosRecyclerView.apply {
        layoutManager = LinearLayoutManager(this@RecordActivity)
        adapter = photoListAdapter
    }
}
```

---

### æ­¥éª¤4ï¼šæ£€æŸ¥è§†é¢‘æ–‡ä»¶è·¯å¾„

**é—®é¢˜ï¼š** è§†é¢‘ä¿å­˜åœ¨ç§æœ‰ç›®å½•ï¼Œç¼©ç•¥å›¾ç”Ÿæˆæ–¹æ³•å¯èƒ½æ— æ³•è®¿é—®

**æ£€æŸ¥RecordActivity.ktä¸­çš„ `createVideoFile()` æ–¹æ³•ï¼š**
```kotlin
private fun createVideoFile(): File? {
    try {
        val timeStamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
        val storageDir = getExternalFilesDir(Environment.DIRECTORY_MOVIES)  // â† è¿™æ˜¯ç§æœ‰ç›®å½•
        return File.createTempFile(
            "COOKING_${timeStamp}_",
            ".mp4",
            storageDir
        )
    } catch (e: Exception) {
        e.printStackTrace()
        return null
    }
}
```

**è§£å†³æ–¹æ¡ˆ1ï¼šä½¿ç”¨å…¬å…±ç›®å½•**
```kotlin
// ä½¿ç”¨Environment.getExternalStoragePublicDirectoryä»£æ›¿getExternalFilesDir
val storageDir = Environment.getExternalStoragePublicDirectory(
    Environment.DIRECTORY_MOVIES + "/CampCooking"
)
if (!storageDir.exists()) {
    storageDir.mkdirs()
}
```

**è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨MediaStoreä¿å­˜è§†é¢‘**
```kotlin
// é€šè¿‡MediaStoreä¿å­˜ï¼Œè¿™æ ·ç³»ç»Ÿä¼šè‡ªåŠ¨ç´¢å¼•
val contentValues = ContentValues().apply {
    put(MediaStore.Video.Media.DISPLAY_NAME, "COOKING_${timeStamp}.mp4")
    put(MediaStore.Video.Media.MIME_TYPE, "video/mp4")
    put(MediaStore.Video.Media.RELATIVE_PATH, Environment.DIRECTORY_MOVIES + "/CampCooking")
    put(MediaStore.Video.Media.IS_PENDING, 1)
}

val uri = contentResolver.insert(MediaStore.Video.Media.EXTERNAL_CONTENT_URI, contentValues)

// å†™å…¥è§†é¢‘æ–‡ä»¶
contentResolver.openOutputStream(uri)?.use { output ->
    // å°†è§†é¢‘æ•°æ®å†™å…¥output
}

// æ ‡è®°ä¸ºå®Œæˆ
contentResolver.update(uri, ContentValues().apply {
    put(MediaStore.Video.Media.IS_PENDING, 0)
}, null, null)
```

---

### æ­¥éª¤5ï¼šæ£€æŸ¥æƒé™

**éœ€è¦çš„æƒé™ï¼š**
```xml
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
```

**æ£€æŸ¥æ–¹æ³•ï¼š**
åœ¨ `onCreate` ä¸­æ·»åŠ æƒé™æ£€æŸ¥æ—¥å¿—
```kotlin
val hasReadPermission = ContextCompat.checkSelfPermission(this, Manifest.permission.READ_EXTERNAL_STORAGE)
val hasWritePermission = ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE)
android.util.Log.d("RecordActivity", "è¯»æƒé™: ${hasReadPermission == PackageManager.PERMISSION_GRANTED}")
android.util.Log.d("RecordActivity", "å†™æƒé™: ${hasWritePermission == PackageManager.PERMISSION_GRANTED}")
```

---

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

### åŸå› 1ï¼šè§†é¢‘æ–‡ä»¶ä¿å­˜åœ¨ç§æœ‰ç›®å½•

**ç—‡çŠ¶ï¼š**
- æ—¥å¿—æ˜¾ç¤ºæ–‡ä»¶å­˜åœ¨
- ä½†ThumbnailUtilsè¿”å›null

**åŸå› ï¼š**
ThumbnailUtilsæ— æ³•è®¿é—®åº”ç”¨çš„ç§æœ‰ç›®å½• `getExternalFilesDir()`

**è§£å†³æ–¹æ¡ˆï¼š**
æ”¹ç”¨å…¬å…±ç›®å½•æˆ–MediaStore

---

### åŸå› 2ï¼šMediaStoreæœªç´¢å¼•è§†é¢‘

**ç—‡çŠ¶ï¼š**
- æ—¥å¿—æ˜¾ç¤º"æ–¹æ³•3: ContentResolver"å¤±è´¥
- æ‰¾ä¸åˆ°è§†é¢‘ID

**åŸå› ï¼š**
è§†é¢‘ä¿å­˜åœ¨ç§æœ‰ç›®å½•ï¼ŒMediaStoreæ— æ³•ç´¢å¼•

**è§£å†³æ–¹æ¡ˆï¼š**
ä½¿ç”¨MediaStore APIä¿å­˜è§†é¢‘

---

### åŸå› 3ï¼šè§†é¢‘æ ¼å¼ä¸æ”¯æŒ

**ç—‡çŠ¶ï¼š**
- æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥

**åŸå› ï¼š**
è§†é¢‘ç¼–ç æ ¼å¼ä¸è¢«ThumbnailUtilsæ”¯æŒ

**è§£å†³æ–¹æ¡ˆï¼š**
ä½¿ç”¨MediaMetadataRetrieverï¼ˆå·²å®ç°ï¼‰

---

## ğŸš€ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šä½¿ç”¨å…¬å…±ç›®å½•ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `RecordActivity.kt` çš„ `createVideoFile()` æ–¹æ³•ï¼š

```kotlin
private fun createVideoFile(): File? {
    try {
        val timeStamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())

        // ä½¿ç”¨å…¬å…±ç›®å½•
        val storageDir = File(
            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_MOVIES),
            "CampCooking"
        )

        if (!storageDir.exists()) {
            storageDir.mkdirs()
        }

        return File(storageDir, "COOKING_${timeStamp}.mp4")
    } catch (e: Exception) {
        e.printStackTrace()
        Toast.makeText(this, "åˆ›å»ºè§†é¢‘æ–‡ä»¶å¤±è´¥", Toast.LENGTH_SHORT).show()
        return null
    }
}
```

**åŒæ—¶æ·»åŠ æƒé™åˆ°AndroidManifest.xmlï¼š**
```xml
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
    android:maxSdkVersion="28" />
```

---

### æ–¹æ¡ˆBï¼šä½¿ç”¨MediaStore APIï¼ˆAndroid 10+æœ€ä½³å®è·µï¼‰

è¿™æ˜¯æœ€å¯é çš„æ–¹æ³•ï¼Œè¯¦è§ä¸Šé¢çš„"è§£å†³æ–¹æ¡ˆ2"ã€‚

---

## ğŸ“± æµ‹è¯•å»ºè®®

1. **å…ˆæŸ¥çœ‹Logcat** - çœ‹å…·ä½“å“ªä¸€æ­¥å¤±è´¥
2. **æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨** - ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨æŸ¥çœ‹ `/Android/data/com.campcooking.ar/files/Movies/`
3. **å°è¯•æ’­æ”¾è§†é¢‘** - å¦‚æœèƒ½æ’­æ”¾è¯´æ˜æ–‡ä»¶æ²¡é—®é¢˜
4. **æŸ¥çœ‹é»˜è®¤ç¼©ç•¥å›¾** - å³ä½¿çœ‹ä¸åˆ°çœŸå®ç¼©ç•¥å›¾ï¼Œä¹Ÿåº”è¯¥èƒ½çœ‹åˆ°ç°è‰²èƒŒæ™¯+æ’­æ”¾å›¾æ ‡

---

## ğŸ’¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœç¼©ç•¥å›¾å®åœ¨æ— æ³•ç”Ÿæˆï¼Œè‡³å°‘ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°ï¼š

1. âœ… è§†é¢‘å›¾æ ‡ï¼ˆæ’­æ”¾æŒ‰é’®ï¼‰
2. âœ… "è§†é¢‘"æ–‡å­—æ ‡ç­¾
3. âœ… è§†é¢‘æ—¶é•¿
4. âœ… æ–‡ä»¶å¤§å°

è¿™äº›éƒ½ä¸ä¾èµ–ç¼©ç•¥å›¾ï¼Œç”¨æˆ·ä»ç„¶èƒ½å¤Ÿè¯†åˆ«å’Œç®¡ç†è§†é¢‘ã€‚

---

## ğŸ”§ æˆ‘å·²ç»å®ç°çš„æ”¹è¿›

1. âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼ˆä¾¿äºæ’æŸ¥ï¼‰
2. âœ… ä¸‰ç§ç¼©ç•¥å›¾åŠ è½½æ–¹æ³•ï¼ˆæé«˜æˆåŠŸç‡ï¼‰
3. âœ… æ”¹è¿›çš„é»˜è®¤ç¼©ç•¥å›¾ï¼ˆæ¸å˜èƒŒæ™¯+æ’­æ”¾å›¾æ ‡ï¼‰
4. âœ… å®Œæ•´çš„è§†é¢‘ä¿¡æ¯æ˜¾ç¤ºï¼ˆæ—¶é•¿ã€å¤§å°ç­‰ï¼‰

å³ä½¿çœŸå®ç¼©ç•¥å›¾åŠ è½½å¤±è´¥ï¼Œç”¨æˆ·ä¹Ÿèƒ½æ¸…æ¥šåœ°çœ‹åˆ°è¿™æ˜¯è§†é¢‘æ–‡ä»¶ï¼

---

**å»ºè®®ï¼š** è¯·å…ˆæŸ¥çœ‹Logcatæ—¥å¿—ï¼Œå‘Šè¯‰æˆ‘å…·ä½“çœ‹åˆ°äº†ä»€ä¹ˆï¼Œæˆ‘å†é’ˆå¯¹æ€§åœ°è§£å†³ï¼
